<?php

/**
  * @file
  * Code for the Faculty Publications feature.
  */
include_once 'cu_faculty_publications_bundle.features.inc';

/**
  * Implements hook_theme_registry_alter().
  *
  * Let Drupal know that we've got bean--faculty_publications.tpl.php in our module
  * directory.
  */
function cu_faculty_publications_bundle_theme_registry_alter(&$theme_registry) {
  $module_path = drupal_get_path('module', 'cu_faculty_publications_bundle');
  $theme_registry_copy = $theme_registry;
  _theme_process_registry($theme_registry_copy, 'phptemplate', 'theme_engine', 'bean', $module_path);
  $theme_registry += array_diff_key($theme_registry_copy, $theme_registry);
  $hooks = array('bean');
  foreach ($hooks as $h) {
    if (isset($theme_registry[$h]['theme paths'])) {
      $first_element = array_shift($theme_registry[$h]['theme paths']);
      array_unshift($theme_registry[$h]['theme paths'], array_shift($theme_registry[$h]['theme paths']), $module_path);
    }
  }
}

/**
  * Implements hook_theme().
  */
function cu_faculty_publications_bundle_theme(&$existing, $type, $theme, $path) {
  $registry = array();
  $template_dir = drupal_get_path('module', 'cu_faculty_publications_bundle') . '/templates';
  $registry['faculty_publication'] = array(
    'template' => 'faculty-publication',
    'path' => $template_dir,
  );
  return $registry;
}

/**
  * Implements hook_preprocess_entity().
  */
function cu_faculty_publications_bundle_preprocess_entity(&$vars) {
  // $entity_type = $vars['elements']['#entity_type'];
  if ($vars['elements']['#bundle'] == 'faculty_publications') {

    $endpoint = variable_get('cu_faculty_publications_endpoint', 'https://experts.colorado.edu/es/fispubs-v1/publication/_search');
    $fisEndpoint = variable_get('cu_faculty_fis_endpoint', 'https://experts.colorado.edu/es/fis/_search');
    $arguments = array();
    $numberOfResultsPerPage = 25;
    $requestedNumberOfResults = 10;
    $currentPage = pager_find_page();

    // Check for publication date filter.
    if (!empty($vars['bean']->field_faculty_publication_date)) {
      $date1 = strtotime($vars['bean']->field_faculty_publication_date[LANGUAGE_NONE][0]['value']);
      $date2 = strtotime($vars['bean']->field_faculty_publication_date[LANGUAGE_NONE][0]['value2']);

      $date1 = date('Y-m-d', $date1);
      $date2 = date('Y-m-d', $date2);
      $arguments['q'][] = 'publicationDate:[' . $date1 . ' TO ' . $date2 . ']';
    }

    // Check for department id or name
    if (!empty($vars['bean']->field_faculty_pub_department)) {
      $department = $vars['bean']->field_faculty_pub_department[LANGUAGE_NONE][0]['value'];

      // Search for a department id number.
      if (intval($department)) {
        $arguments['q'][] = "authors.organization.uri:*_$department";
      }

      // Use name as search term.
      // TODO: more string validation here?
      else {
        $arguments['q'][] = "authors.organization.name:$department";
      }
    }

    // Check for sort order.
    if (!empty($vars['bean']->field_faculty_publications_sort)) {
      $order = $vars['bean']->field_faculty_publications_sort[LANGUAGE_NONE][0]['value'];

      if ($order === "date-desc") {
        $arguments['sort'] = 'publicationDate:desc';
      }
      else if ($order === "date-asc") {
        $arguments['sort'] = 'publicationDate:asc';
      }
    }

    // Gather emails from all sources.
    $authorEmails = array();

    if (!empty($vars['bean']->field_faculty_publication_email)) {
      $authorEmails = array_merge($authorEmails, get_array_from_field_data($vars['bean']->field_faculty_publication_email[LANGUAGE_NONE], 'email'));
    }    

    if (!empty($vars['bean']->field_faculty_publication_name)) {
      $authorEmails = array_merge($authorEmails, get_array_from_field_data($vars['bean']->field_faculty_publication_name[LANGUAGE_NONE], 'value'));
    }

    if (!empty($vars['bean']->field_people_list_person_type)) {
      $tids = get_array_from_field_data($vars['bean']->field_people_list_person_type[LANGUAGE_NONE], 'tid');
      $authorEmails = array_merge($authorEmails, get_emails_assoc_with_jobs($tids));
    }

    $authorEmails = array_unique($authorEmails);
    $orcidResults = get_author_orcids($authorEmails, $fisEndpoint);
    $noOrcidResult = get_html_no_result_string($orcidResults['noResults'], 'Orcid');
    
    // Add all of the authors' orcids to arguments['q'] array if there are any.
    if (count($orcidResults['orcids']) > 0) {
      $orcids = $orcidResults['orcids'];
      $authorOrcidStringQuoted = formQueryStringFromArray($orcids);
      $arguments['q'][] = "authors.orcid:$authorOrcidStringQuoted";
    }


    // Check for requestedNumberOfResults.
    if (!empty($vars['bean']->field_faculty_pub_results)) {
      $numberOfResults = $vars['bean']->field_faculty_pub_results[LANGUAGE_NONE][0]['value'];
      $offset = $currentPage * $numberOfResultsPerPage;
      $arguments['from'] = $offset;
      $arguments['size'] = $numberOfResultsPerPage;

      if ($numberOfResults === 'all') {
        // 10,000 search results is the default maximum amount of Elastic Search results.
        $requestedNumberOfResults = 10000;
      }

      elseif ($numberOfResults === '25' || $numberOfResults === '50' || $numberOfResults === '100') {
        $requestedNumberOfResults = intval($numberOfResults);
      }
    }

    // Convert all 'q' arguments to a string joined by ' AND ' operator.
    if (count($arguments['q']) > 1) {
      $arguments['q'] = implode(' AND ', $arguments['q']);
    }
    elseif (count($arguments['q']) === 1) {
      $arguments['q'] = $arguments['q'][0];
    }

    // Form the final request url.
    $elasticSearchRequest = url($endpoint, ['query' => $arguments]);

    // Send query to facutly publications database and display results.
    $publications = get_publication_data($elasticSearchRequest);

    if ($publications['results']) {
      $totalResults = $publications['total'] > $requestedNumberOfResults ? $requestedNumberOfResults : $publications['total'];
      pager_default_initialize($totalResults, $numberOfResultsPerPage);

      // Check if results are from cache.
      // Put in an HTML comment to confirm if results are from cache or not.
      $isFromCache = $publications['isFromCache'] ? "YES" : "NO";
      $vars['content']['publications'][]['#markup'] = "<!-- Results are from cache: $isFromCache -->";

      foreach ($publications['results'] as $item) {
        $vars['content']['publications'][]['#markup'] = theme('faculty_publication', $item['_source']);
      }

      $vars['content']['publications'][]['#markup'] = theme('pager');
    }

    else {
      $vars['content']['no_results']['#markup'] .= '<h4>There are no results for your query. Please check your data filters and try again.</h4>' . $noOrcidResult;
    }
  }
}

// Here are many helper functions used in cu_faculty_publications_bundle_preprocess_entity() above.
function get_array_from_field_data($fieldArray, $fieldArrayFinalIdentifier) {
  return array_map(function($data) use($fieldArrayFinalIdentifier) { return strtolower($data[$fieldArrayFinalIdentifier]); }, $fieldArray);
}

function get_author_orcids($authorEmailArray, $dbUrl) {
  $orcids = array();
  $authorEmailString = formQueryStringFromArray($authorEmailArray);
  $queryArray = ['q' => "email:{$authorEmailString}"];
  $requestUrl = url($dbUrl, ['query' => $queryArray]);
  $emailResponse = drupal_http_request($requestUrl);

  if ($emailResponse->code =='200') {
    $emailResult = drupal_json_decode($emailResponse->data, true);
    $data = $emailResult['hits']['hits'];
    // get the orcids from each database hit
    foreach($data as $author) {
      $authorOrcid = $author['_source']['orcid'];
      $authorEmail = strtolower($author['_source']['email'][0]);
      if ($authorOrcid) {
        array_push($orcids, $authorOrcid);
        $index = array_search($authorEmail, $authorEmailArray);
        array_splice($authorEmailArray, $index, 1);
      }
    }
  }

  return ['orcids' => $orcids, 'noResults' => $authorEmailArray];
}

function formQueryStringFromArray($arr) {
  $arrayQuoted = array_map(function($data) { return "\"" . $data . "\""; }, $arr);
  return implode(" OR ", $arrayQuoted);
}

function get_html_no_result_string($noResultArray, $label) {
  $warningString = "<p>No {$label} found for:<p><ul>";
  foreach ($noResultsArray as $data) {
    $warningString .= "<li>$data.</li>";
  }
  $warningString .= "</ul";
  return $warningString;
}

function get_publication_data($url) {
  $publications = [];
  // Use the elastic search url as the cache id.
  $cache = cache_get($url, 'cache_cu_faculty_publications_bundle');

  if (isset($cache->data)) {
    $publications = $cache->data['publications'];
    $publications['isFromCache'] = true;
  }
  
  if ($cache->data['expiration'] <= time() || !isset($cache->data)) {
    $response = drupal_json_decode(drupal_http_request($url)->data, true);
    
    if ($response) {
      $newData = [
        'publications' => [
          'total' => $response['hits']['total'],
          'results' => $response['hits']['hits'],
        ],
        'expiration' => time() + (24 * 60 * 60)
      ];
  
      cache_set($url, $newData, 'cache_cu_faculty_publications_bundle');
      if (!isset($cache->data)) {
        $publications = $newData['publications'];
        $publications['isFromCache'] = false;
      }
    }
  }

  return $publications;
}

function cu_faculty_publications_bundle_person_names() {
  $query = db_select('field_data_field_person_email', 'email');
  $query->join('field_data_field_person_first_name', 'fn', 'email.entity_id = fn.entity_id');
  $query->join('field_data_field_person_last_name', 'ln', 'email.entity_id = ln.entity_id');
  $query->addField('email', 'field_person_email_email', 'e_mail');
  $query->addField('fn', 'field_person_first_name_value', 'first_name');
  $query->addField('ln', 'field_person_last_name_value', 'last_name');
  $query->orderBy('last_name', 'ASC');
  $query->orderBy('first_name', 'ASC');
  $result = $query->execute();
  
  $facultyNamesAndEmails = [];
  foreach ($result as $record) {
    $firstName = $record->first_name;
    $lastName = $record->last_name;
    $email = strtolower($record->e_mail);
    $facultyNamesAndEmails[$email] = "$firstName $lastName";
  }

  return $facultyNamesAndEmails;
}

function get_emails_assoc_with_jobs($jobsTidArray) {
  $query = db_select('field_data_field_person_email', 'email');
  $query->join('field_data_field_person_job_type', 'job', 'job.entity_id = email.entity_id');
  $query->addField('email', 'field_person_email_email');
  $query->condition('job.field_person_job_type_tid', $jobsTidArray, 'IN');

  $result = $query->execute()->fetchCol();
  $emails = array_map(function($email) {return strtolower($email);}, $result);
  return $emails;
}

function cu_faculty_publications_sort() {
  return array('date-desc' => 'Newest to Oldest', 'date-asc' => 'Oldest to Newest');
}

function cu_faculty_publications_results() {
  return array('25' => '25', '50' => '50' , '100' => '100', 'all' => 'ALL');
}
// End cu_faculty_publications_bundle_preprocess_entity() helper functions.

/**
  * Implements hook_secure_permissions().
  *
  * Adding permissions for newsletter
  */
function cu_faculty_publications_bundle_secure_permissions($role) {
  $permissions = array(
    'anonymous user' => array(
      'view any faculty_publications bean',
    ),
    'authenticated user' => array(
      'view any faculty_publications bean',
    ),
    'administrator' => array(
      'create any faculty_publications bean',
      'delete any faculty_publications bean',
      'edit any faculty_publications bean',
      'view any faculty_publications bean',
    ),
    'developer' => array(
      'create any faculty_publications bean',
      'delete any faculty_publications bean',
      'edit any faculty_publications bean',
      'view any faculty_publications bean',
    ),
    'edit_my_content' => array(
      'view any faculty_publications bean',
    ),
    'edit_only' => array(
      'edit any faculty_publications bean',
      'view any faculty_publications bean',
    ),
    'site_editor' => array(
      'create any faculty_publications bean',
      'delete any faculty_publications bean',
      'edit any faculty_publications bean',
      'view any faculty_publications bean',
    ),
    'site_owner' => array(
      'create any faculty_publications bean',
      'delete any faculty_publications bean',
      'edit any faculty_publications bean',
      'view any faculty_publications bean',
    ),
  );

  if (isset($permissions[$role])) {
    return $permissions[$role];
  }
}

/**
  * Implements hook_flush_caches().
  */
function cu_faculty_publications_bundle_flush_caches() {
  return array('cache_cu_faculty_publications_bundle');
}